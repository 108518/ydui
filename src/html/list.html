<!DOCTYPE html>
<html style="height: 100%;">
<head>
    <meta charset="UTF-8">
    <title>List</title>
    <meta content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0" name="viewport"/>
    <meta content="yes" name="apple-mobile-web-app-capable"/>
    <meta content="black" name="apple-mobile-web-app-status-bar-style"/>
    <meta content="telephone=no" name="format-detection"/>
    <link href="//static.ydcss.com/app-icon144x144@2x.png" rel="apple-touch-icon-precomposed">
    <link rel="stylesheet" href="../css/ydui.css?rev=@@hash"/>
    <link rel="stylesheet" href="../css/example.css" />
    <!-- build:tb_flexible -->
    <script src="../js/yd_flexible.js"></script>
    <!-- endbuild -->
</head>
<body>
<section class="g-doc">
    <header class="m-nav">
        <nav>
            <a href="../index.html" class="back-ico"></a>
            <div class="center">List</div>
            <a href="javascript:;" class="nav-ico icon-sortlist" id="J_ChangeView"></a>
        </nav>
    </header>
    <aside class="example-tip">
        <p>本页包含功能点：</p>
        <p><i>①</i>进入详情页后，返回后，定位之前位置；</p>
        <p><i>②</i>图片不管是否正方形，不会导致页面显示错乱；</p>
        <p><i>③</i>三种排版方式切换；</p>
        <p><i>④</i>滚动加载数据；需要“点击加载更多”<a href="loadmore.html">在这里</a>；</p>
    </aside>
    <section class="m-list" id="J_ListCon">
        <section class="m-listbox" id="J_List"></section><!-- 数据填充DOM -->
        <div class="list-tip" id="J_ListTip">没有更多数据了</div><!-- 没有数据时显示 -->
        <div class="loading" id="J_Loading"><img src="http://static.ydcss.com/uploads/ydui/loading/loading10.svg" /></div>
    </section>
</section>
<!-- 列表数据模板 -->
<script id="J_ListHtml" type="text/html">
    {{each list as data}}
    <a href="javascript:;" class="m-listitem J_ListRedirect" data-page="{{list.realpage}}" data-href="{{data.url}}">
        <div class="m-listimg">
            <img src="http://static.ydcss.com/uploads/ydui/default.jpg" data-original="{{data.img}}"/>
        </div>
        <div class="m-listtitle">
            <h3 class="title">{{list.realpage}}-{{data.title}}(page{{list.realpage}})</h3>
            <p><span class="price"><em>¥</em>{{data.marketprice}}</span>
                <del>¥{{data.productprice}}</del>
            </p>
        </div>
    </a>
    {{/each}}
</script>
<script src="http://static.ydcss.com/libs/jquery/2.1.3/jquery.js"></script>
<script src="http://static.ydcss.com/libs/arttemplate/template.js"></script>
<script src="http://static.ydcss.com/libs/lazyload/jquery.lazyload.js"></script>
<script src="../libs/dataload/jquery.dataload.js"></script>
<script src="../js/util.js"></script>
<script>
    !function ($, window, util) {
        /**
         * 三种排版方式
         **/
        var listView = {
            key: 'viewtype',//本地存储key(排版方式)
            viewtype: ['larger', 'largest', 'list'],//排版方式
            // 需要找三种图片的规则 http://img1.shikee.com/try/2016/02/29/12240320922862852966.jpg_295x295.jpg
            imgwidth: ['_220x220.jpg', '_295x295.jpg', '_180x180.jpg'],
            //切换排版方式
            changeLayout: function () {
                $('#J_ChangeView').removeClass().addClass('nav-ico icon-sort' + listView.viewtype[viewTypeIndex]);
                $('#J_List').removeClass()
                        .addClass('m-listbox ' + listView.viewtype[viewTypeIndex] + '-view')
                        .find('img').each(function () {
                            var $this = $(this);
                            $this.attr('src', $this.data('original') + listView.imgwidth[viewTypeIndex]);
                        });
            }
        };
        var localKey = util.localStorage.get(listView.key);
        var viewTypeIndex = localKey ? listView.viewtype.indexOf(localKey) : 0;

        listView.changeLayout();

        //切换排版方式
        $('#J_ChangeView').on('click', function () {
            ++viewTypeIndex;
            if (viewTypeIndex > listView.viewtype.length - 1) {
                viewTypeIndex = 0;
            }
            util.localStorage.set(listView.key, listView.viewtype[viewTypeIndex % listView.viewtype.length]);
            listView.changeLayout();
        });

        /**
         * 返回后，定位之前位置逻辑：
         * ①加载数据后将每页数据存入SessionStorage
         * ②跳转详情页方式，改为js触发跳转并记录当前页码
         * ③返回列表页判断是否需要滚动到之前位置，是则加载对应数据，而后浏览器将会自动滚动
         */
        var page = 1;//起始页码
        var backPosition = {
            storagePageKey: 'LIST_PAGE',//储存当页码的本地存储key
            storageListKey: 'LIST_DATA',//储存列表数据的本地存储key
            loadPage: 0,//页码
            /**
             * 从本地存储取出相应数据
             */
            getHtml: function () {
                var that = this;

                //总需滚动的页码数
                var num = that.loadPage;

                //记录下次加载的正确页数
                page = num + 1;

                //从SessionStorage获取需要显示的列表数据，并形成HTML
                var html = '';
                for (var i = 1; i <= num; i++) {
                    var _data = util.sessionStorage.get(that.storageListKey + i);
                    if (_data) {
                        _data.realpage = i;
                        html += template('J_ListHtml', {list: _data});
                    }
                }
                that.appendDOM(html);
            },
            /**
             * 获取页码
             */
            getLoadPage: function () {
                var page = util.sessionStorage.get(backPosition.storagePageKey);

                //取出页码后立即将其删除！！！
                util.sessionStorage.remove(backPosition.storagePageKey);

                backPosition.loadPage = page;

                return page;
            },
            /**
             * 将HTML插入页面
             * @param html
             */
            appendDOM: function (html) {
                //无排版方式直接使用↓↓↓
                //$('#J_List').append(html).find('img').lazyload();

                $('#J_List').append(html).find('img').each(function () {
                    var $this = $(this);
                    $this.attr('data-original', $this.data('original') + listView.imgwidth[viewTypeIndex]);
                }).lazyload();
            }
        };

        //判断是否需要自动加载数据并滚动页面
        !!backPosition.getLoadPage() && backPosition.getHtml();

        //调用插件实现滚动加载
        $('#J_ListCon').dataload({
            url: 'http://static.ydcss.com/uploads/ydui/list.js',//模拟的jsonp数据
            page: page,
            pageSize: 10,
            dataType: 'jsonp',
            pagestr: 'testpage',//请求数据时，参数page字符串 默认：page
            jsonpCallback: 'callback',//jsonp时需要
            loadtype: 'scroll',//加载类型 scroll or click；click时需指定loadmoredom，触发加载数据的DOM
            data: {aaa: 'aaa'},//需要传输的数据
            loadingdom: '#J_Loading',//loading的DOM
            callback: function (ret, retPage) {
                ret.realpage = retPage;
                //填充HTML
                backPosition.appendDOM(template('J_ListHtml', {list: ret}));

                //储存每页数据
                util.sessionStorage.set(backPosition.storageListKey + retPage, ret);
            }
        }).delegate('.J_ListRedirect', 'click', function (e) {
            //原来的a链接 改用js触发跳转
            e.stopPropagation();

            var $this = $(this);
            //储存当前页码
            util.sessionStorage.set(backPosition.storagePageKey, $this.data('page'));
            location.href = $this.data('href');
        });
    }(jQuery, window, YDUI.util);
</script>
</body>
</html>